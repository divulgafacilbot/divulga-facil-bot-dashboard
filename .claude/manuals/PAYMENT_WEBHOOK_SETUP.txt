═══════════════════════════════════════════════════════════════
KIWIFY PAYMENT WEBHOOK SETUP - COMPLETE GUIDE
═══════════════════════════════════════════════════════════════

Generated: 2025-12-24
For project: Posting Bot SaaS

This manual will guide you through setting up Kiwify payment webhooks
to automatically handle subscription purchases, renewals, and cancellations.

═══════════════════════════════════════════════════════════════
OVERVIEW
═══════════════════════════════════════════════════════════════

What you will accomplish:
- Configure Kiwify webhook URL
- Get webhook secret key
- Test webhook events
- Verify subscription automation works

What you will need:
- Kiwify account (producer account)
- Your API deployed and accessible from internet
- 15-20 minutes of time

Estimated time: 15-20 minutes

IMPORTANT: You must deploy your API BEFORE setting up webhooks.
          Kiwify needs to send test events to your server.

═══════════════════════════════════════════════════════════════
PREREQUISITES
═══════════════════════════════════════════════════════════════

Before starting, ensure:

✓ Your API is deployed to Railway (see DEPLOY_API_SETUP.txt)
✓ Your API is accessible via public URL (e.g., https://posting-bot-api.up.railway.app)
✓ You have a Kiwify producer account
✓ You have created products in Kiwify

If any of these are not ready, complete them first.

═══════════════════════════════════════════════════════════════
STEP 1: Get Your Webhook URL
═══════════════════════════════════════════════════════════════

1.1 - Your webhook URL format is:
      https://[your-api-domain]/api/webhooks/kiwify

1.2 - Examples:
      - Railway: https://posting-bot-api.up.railway.app/api/webhooks/kiwify
      - Custom domain: https://api.yourdomain.com/api/webhooks/kiwify

1.3 - Write down your webhook URL:

      MY WEBHOOK URL:
      _________________________________________________

1.4 - VERIFY the URL is correct:
      - Must start with https:// (not http://)
      - Must be publicly accessible (not localhost)
      - Must end with /api/webhooks/kiwify

EXPECTED RESULT: You have your webhook URL ready

───────────────────────────────────────────────────────────────

STEP 2: Log Into Kiwify

2.1 - Open your web browser

2.2 - Navigate to: https://kiwify.com.br

2.3 - Click "Entrar" (Login) button in top right

2.4 - Enter your credentials:
      - Email
      - Password

2.5 - Click "Entrar" to log in

2.6 - You should see the Kiwify dashboard

EXPECTED RESULT: You are logged into Kiwify dashboard

TROUBLESHOOTING:
- If you don't have an account: click "Criar conta" to sign up
- If forgot password: click "Esqueci minha senha"

───────────────────────────────────────────────────────────────

STEP 3: Navigate to Webhook Settings

3.1 - In the Kiwify dashboard, look for the menu sidebar
      (usually on the left side)

3.2 - Look for "Configurações" (Settings) or gear icon

3.3 - Click on "Configurações"

3.4 - In the settings menu, look for:
      - "Integrações" (Integrations) OR
      - "Webhooks" OR
      - "API e Webhooks"

3.5 - Click on the webhook/integration option

3.6 - You should see the webhook configuration page

EXPECTED RESULT: You are on the webhook settings page

TROUBLESHOOTING:
- If can't find webhooks: use search box in dashboard
- If webhooks not available: ensure you have producer account
- Different layout: Kiwify may have updated UI, look for similar names

───────────────────────────────────────────────────────────────

STEP 4: Configure Webhook URL

4.1 - On the webhook settings page, you should see:
      - A field for "URL do Webhook" (Webhook URL)
      - Events you want to receive
      - Test webhook button

4.2 - In the "URL do Webhook" field, paste your webhook URL:
      https://[your-api-domain]/api/webhooks/kiwify

      Example:
      https://posting-bot-api.up.railway.app/api/webhooks/kiwify

4.3 - Select the events you want to receive:

      ✓ order.paid (Pedido Pago) - CRITICAL!
      ✓ order.refunded (Pedido Reembolsado) - CRITICAL!
      ✓ subscription.created (Assinatura Criada)
      ✓ subscription.updated (Assinatura Atualizada)
      ✓ subscription.canceled (Assinatura Cancelada) - CRITICAL!
      ✓ subscription.expired (Assinatura Expirada) - CRITICAL!

      IMPORTANT: Select ALL events to ensure nothing is missed!

4.4 - Look for "Segredo do Webhook" (Webhook Secret) field

4.5 - If the secret is shown:
      - Copy the entire secret key
      - It's usually a long random string

      If there's a "Gerar Segredo" (Generate Secret) button:
      - Click it to generate a new secret
      - Copy the generated secret

4.6 - SAVE THE WEBHOOK SECRET immediately:
      - Open a text file: kiwify-webhook-secret.txt
      - Paste the secret
      - Save the file

4.7 - Click "Salvar" (Save) button to save webhook configuration

EXPECTED RESULT: Webhook URL and events configured

TROUBLESHOOTING:
- If webhook URL is rejected: ensure it's https:// and publicly accessible
- If can't save: check that URL is valid and reachable

───────────────────────────────────────────────────────────────

STEP 5: Configure .env File

5.1 - Navigate to your project folder:
      /home/pedro/Desktop/Repositórios/5 Freelances/Posting-bot/implementation

5.2 - Open: apps/api/.env

5.3 - Find this line:
      KIWIFY_WEBHOOK_SECRET=

5.4 - Paste your webhook secret after the equals sign:
      KIWIFY_WEBHOOK_SECRET=[your_secret_here]

      NO SPACES!
      NO QUOTES!

5.5 - Save the file

5.6 - IMPORTANT: Redeploy your API to Railway
      - The new KIWIFY_WEBHOOK_SECRET must be in production
      - In Railway dashboard, add the env var
      - Trigger a new deployment

EXPECTED RESULT: Webhook secret configured in .env

───────────────────────────────────────────────────────────────

STEP 6: Test Webhook

6.1 - Back in Kiwify webhook settings page

6.2 - Look for "Testar Webhook" (Test Webhook) button

6.3 - Click "Testar Webhook"

6.4 - Kiwify will send a test event to your webhook URL

6.5 - You should see a success message:
      "Webhook enviado com sucesso!" (Webhook sent successfully!)

      OR an error message:
      "Falha ao enviar webhook" (Failed to send webhook)

6.6 - If successful:
      - Great! Your webhook is working
      - Check your API logs to see the event received

6.7 - If failed:
      - Check that your API is running
      - Verify the webhook URL is correct
      - Check API logs for errors
      - Ensure /api/webhooks/kiwify endpoint exists

EXPECTED RESULT: Test webhook sent successfully

TROUBLESHOOTING:
- If test fails: verify API is deployed and accessible
- If endpoint not found: ensure you deployed the webhook route code
- If authentication error: verify KIWIFY_WEBHOOK_SECRET matches

───────────────────────────────────────────────────────────────

STEP 7: Verify Webhook Endpoint (Technical)

7.1 - Open a new browser tab

7.2 - Navigate to: https://[your-api-domain]/health

      Example:
      https://posting-bot-api.up.railway.app/health

7.3 - You should see a JSON response:
      {
        "status": "ok",
        "timestamp": "2025-12-24T10:30:00.000Z"
      }

7.4 - This confirms your API is running

7.5 - Now check if webhook endpoint is implemented:
      - You can't directly visit /api/webhooks/kiwify in browser
        (it only accepts POST requests)
      - But you verified it with Kiwify's test in Step 6

EXPECTED RESULT: API health check returns OK

═══════════════════════════════════════════════════════════════
STEP 8: Create Kiwify Products
═══════════════════════════════════════════════════════════════

You need to create products in Kiwify that match your subscription plans.

8.1 - In Kiwify dashboard, go to "Produtos" (Products)

8.2 - Click "Criar Produto" (Create Product)

8.3 - Create these products:

      PRODUCT 1: Pro Monthly
      ─────────────────────────────────────
      - Nome: Posting Bot - Plano Pro Mensal
      - Tipo: Assinatura (Subscription)
      - Valor: R$ 29,90 (or your price)
      - Cobrança: Mensal (Monthly)
      - URL: posting-bot-pro-monthly

      PRODUCT 2: Pro Yearly
      ─────────────────────────────────────
      - Nome: Posting Bot - Plano Pro Anual
      - Tipo: Assinatura (Subscription)
      - Valor: R$ 299,00 (or your price)
      - Cobrança: Anual (Yearly)
      - URL: posting-bot-pro-yearly

8.4 - For each product:
      - Complete all required fields
      - Upload a product image
      - Write a description
      - Save the product

8.5 - After saving, note the Product ID for each:
      - Click on the product
      - Look for "ID do Produto" or in the URL
      - Example: prod_abc123xyz

8.6 - Map Product IDs to your database plans:

      In your database, you have these plan IDs:
      - Free Trial (created by migration)
      - Pro Monthly (you'll need to link this to Kiwify product)
      - Pro Yearly (you'll need to link this to Kiwify product)

      The webhook will use product IDs to identify which plan
      the user purchased.

EXPECTED RESULT: Products created in Kiwify

═══════════════════════════════════════════════════════════════
WEBHOOK EVENTS EXPLAINED
═══════════════════════════════════════════════════════════════

When users interact with your products, Kiwify sends these events:

order.paid
──────────
Sent when: User completes payment
Action: Create or activate subscription
Data includes: customer email, product ID, transaction ID

order.refunded
──────────────
Sent when: Payment is refunded
Action: Mark subscription as REFUNDED, revoke access
Data includes: transaction ID, refund amount

subscription.created
────────────────────
Sent when: Recurring subscription starts
Action: Log subscription creation
Data includes: subscription ID, customer info

subscription.updated
────────────────────
Sent when: Subscription details change
Action: Update subscription record
Data includes: new expiration date, status

subscription.canceled
─────────────────────
Sent when: User or admin cancels subscription
Action: Mark subscription as CANCELED
Data includes: cancellation date, reason

subscription.expired
────────────────────
Sent when: Subscription period ends without renewal
Action: Mark subscription as EXPIRED, revoke access
Data includes: expiration date

Your webhook endpoint handles all these automatically!

═══════════════════════════════════════════════════════════════
VALIDATION CHECKLIST
═══════════════════════════════════════════════════════════════

Before proceeding, verify:

✓ API is deployed and accessible via public URL
✓ Webhook URL configured in Kiwify
✓ Webhook secret generated and saved
✓ KIWIFY_WEBHOOK_SECRET added to apps/api/.env
✓ KIWIFY_WEBHOOK_SECRET added to Railway environment variables
✓ Test webhook sent successfully from Kiwify
✓ All required events selected (order.paid, order.refunded, etc.)
✓ Products created in Kiwify (Pro Monthly, Pro Yearly)
✓ Product IDs noted for database mapping

═══════════════════════════════════════════════════════════════
TESTING WEBHOOKS IN PRODUCTION
═══════════════════════════════════════════════════════════════

After setup, test the complete flow:

Test 1: New Purchase
────────────────────
1. Create a test user in your app
2. Use Kiwify's test payment mode
3. "Purchase" Pro Monthly plan
4. Check webhook received in API logs
5. Verify subscription created in database
6. Confirm user has access to bots

Test 2: Refund
──────────────
1. In Kiwify, refund the test purchase
2. Check webhook received
3. Verify subscription status changed to REFUNDED
4. Confirm user lost access

Test 3: Subscription Expiration
───────────────────────────────
1. Wait for test subscription to expire (or manually trigger)
2. Check webhook received
3. Verify subscription status changed to EXPIRED
4. Confirm user lost access

═══════════════════════════════════════════════════════════════
MONITORING WEBHOOKS
═══════════════════════════════════════════════════════════════

Check webhook health regularly:

In Kiwify:
- Go to webhook settings
- Check "Histórico de Webhooks" (Webhook History)
- Look for failed deliveries (red indicators)
- Retry failed webhooks if needed

In Your API:
- Check logs for webhook events
- Monitor for errors in webhook processing
- Set up alerts for webhook failures
- Track successful vs failed webhook processing

In Your Database:
- Query kiwify_events table
- Look for events with status = 'failed'
- Investigate and resolve failures

═══════════════════════════════════════════════════════════════
WHAT TO DO NEXT
═══════════════════════════════════════════════════════════════

After completing this manual:

1. Webhooks are configured and working

2. When users purchase:
   - Kiwify sends webhook to your API
   - API creates/updates subscription
   - User gets access automatically
   - No manual intervention needed!

3. Monitor webhook activity:
   - Check Kiwify webhook history weekly
   - Review API logs for webhook errors
   - Set up email alerts for webhook failures

4. Handle edge cases:
   - Payment disputes
   - Duplicate webhooks (idempotency is built-in)
   - Network failures (Kiwify will retry)

5. Update webhook configuration if:
   - API URL changes
   - New events are needed
   - Secret needs rotation

═══════════════════════════════════════════════════════════════
REFERENCE
═══════════════════════════════════════════════════════════════

Webhook URL Format:
https://[your-domain]/api/webhooks/kiwify

Required Events:
- order.paid ✓
- order.refunded ✓
- subscription.created ✓
- subscription.updated ✓
- subscription.canceled ✓
- subscription.expired ✓

Environment Variables:
KIWIFY_WEBHOOK_SECRET=[your secret key]

Kiwify Resources:
- Dashboard: https://kiwify.com.br/dashboard
- Documentação: https://docs.kiwify.com.br
- Suporte: suporte@kiwify.com.br

Database Tables:
- subscriptions (main subscription records)
- kiwify_events (webhook event log)

═══════════════════════════════════════════════════════════════
TROUBLESHOOTING
═══════════════════════════════════════════════════════════════

Issue: Webhooks not arriving
Solution:
  1. Check Kiwify webhook history for errors
  2. Verify API is accessible publicly
  3. Check firewall rules
  4. Ensure webhook URL is correct

Issue: Webhook authentication failed
Solution:
  1. Verify KIWIFY_WEBHOOK_SECRET in Railway matches Kiwify
  2. Check for extra spaces in .env
  3. Regenerate secret in Kiwify
  4. Update .env and redeploy

Issue: Duplicate subscriptions created
Solution:
  1. Check kiwify_events table for duplicate events
  2. Webhook handler should be idempotent (already implemented)
  3. Verify transaction IDs are unique

Issue: Subscription not activated after payment
Solution:
  1. Check API logs for webhook processing errors
  2. Verify order.paid event is enabled in Kiwify
  3. Check database for subscription record
  4. Manually trigger webhook retry in Kiwify

Issue: Refund not revoking access
Solution:
  1. Check order.refunded event is enabled
  2. Verify webhook handler updates subscription status
  3. Check subscription table for REFUNDED status
  4. Review access control logic in bot code

═══════════════════════════════════════════════════════════════
SECURITY BEST PRACTICES
═══════════════════════════════════════════════════════════════

1. ALWAYS validate webhook signature
   - Your webhook handler must verify KIWIFY_WEBHOOK_SECRET
   - Reject webhooks with invalid signatures
   - This prevents unauthorized access

2. Use HTTPS only
   - Never use http:// for webhook URL
   - Kiwify may reject non-HTTPS URLs

3. Rotate webhook secret periodically
   - Every 6-12 months
   - After any suspected security breach
   - Update both Kiwify and .env

4. Log all webhook events
   - Helps with debugging
   - Provides audit trail
   - Detect anomalies

5. Rate limit webhook endpoint (optional)
   - Prevent abuse
   - Already handled by idempotency checks

═══════════════════════════════════════════════════════════════
END OF MANUAL
═══════════════════════════════════════════════════════════════
