generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email               String               @unique @db.VarChar(255)
  passwordHash        String               @map("password_hash") @db.VarChar(255)
  role                String?              @default("USER") @db.VarChar(50)
  isActive                Boolean?                   @default(true) @map("is_active")
  emailVerified           Boolean?                   @default(false) @map("email_verified")
  createdAt               DateTime?                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime?                  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  passwordResetTokens     PasswordResetToken[]
  refreshTokens           RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  loginHistory            LoginHistory[]
  subscriptions           subscriptions?
  telegram_bot_links      telegram_bot_links[]
  telegram_links          telegram_links[]
  telemetry_events        telemetry_events[]
  usage_counters          usage_counters[]
  user_brand_configs      user_brand_configs?
  user_templates          user_templates[]
  user_layout_preferences user_layout_preferences?
  support_tickets         support_tickets[]
  payments                payments[]
  billing_disputes        billing_disputes[]
  campaign_downloads      campaign_downloads[]

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model PasswordResetToken {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  tokenHash String    @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expiresAt], map: "idx_password_reset_tokens_expires_at")
  @@index([userId], map: "idx_password_reset_tokens_user_id")
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz(6)
  ipAddress String?   @map("ip_address") @db.VarChar(45)
  userAgent String?   @map("user_agent") @db.VarChar(255)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_refresh_tokens_user_id")
  @@index([expiresAt], map: "idx_refresh_tokens_expires_at")
  @@index([tokenHash], map: "idx_refresh_tokens_token_hash")
  @@map("refresh_tokens")
}

model EmailVerificationToken {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_email_verification_tokens_user_id")
  @@index([expiresAt], map: "idx_email_verification_tokens_expires_at")
  @@map("email_verification_tokens")
}

model LoginHistory {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId        String?   @map("user_id") @db.Uuid
  email         String    @db.VarChar(255)
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent")
  success       Boolean   @default(false)
  failureReason String?   @map("failure_reason") @db.VarChar(255)
  loginAt       DateTime? @default(now()) @map("login_at") @db.Timestamptz(6)
  location      String?   @db.VarChar(255)
  deviceInfo    Json?     @map("device_info")
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_login_history_user_id")
  @@index([email], map: "idx_login_history_email")
  @@index([loginAt(sort: Desc)], map: "idx_login_history_login_at")
  @@index([success], map: "idx_login_history_success")
  @@map("login_history")
}

model kiwify_events {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  event_id    String    @unique(map: "idx_kiwify_events_event_id") @db.VarChar(255)
  event_type  String?   @db.VarChar(100)
  payload     Json
  received_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([received_at], map: "idx_kiwify_events_received_at")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model plans {
  id                         String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                       String          @db.VarChar(100)
  billing_cycle              String?         @default("MONTHLY") @db.VarChar(50)
  max_artes_por_dia          Int?            @default(10)
  max_downloads_por_dia      Int?            @default(10)
  max_execucoes_simultaneas  Int?            @default(1)
  cooldown_entre_requisicoes Int?            @default(5)
  acesso_bot_geracao         Boolean?        @default(false)
  acesso_bot_download        Boolean?        @default(false)
  created_at                 DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at                 DateTime?       @default(now()) @db.Timestamptz(6)
  subscriptions              subscriptions[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model subscriptions {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id               String?   @unique @db.Uuid
  plan_id               String?   @db.Uuid
  status                String?   @default("ACTIVE") @db.VarChar(50)
  expires_at            DateTime? @db.Timestamptz(6)
  kiwify_customer_id    String?   @db.VarChar(255)
  kiwify_transaction_id String?   @db.VarChar(255)
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  updated_at            DateTime? @default(now()) @db.Timestamptz(6)
  plans                 plans?    @relation(fields: [plan_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                 User?     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expires_at], map: "idx_subscriptions_expires_at")
  @@index([status], map: "idx_subscriptions_status")
  @@index([user_id], map: "idx_subscriptions_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model telegram_bot_links {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id          String    @db.Uuid
  bot_type         String    @db.VarChar(50)
  telegram_user_id String    @db.VarChar(100)
  chat_id          String    @db.VarChar(100)
  linked_at        DateTime? @default(now()) @db.Timestamptz(6)
  users            User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, bot_type], map: "user_id_bot_type")
  @@index([user_id], map: "idx_telegram_bot_links_user_id")
}

model telegram_links {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String    @db.Uuid
  bot_type   String    @default("ARTS") @db.VarChar(50)
  token      String    @db.VarChar(255)
  expires_at DateTime  @db.Timestamptz(6)
  status     String    @default("PENDING") @db.VarChar(50)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_telegram_links_user_id")
  @@index([token], map: "idx_telegram_links_token")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model telemetry_events {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  event_type       String    @db.VarChar(100)
  user_id          String?   @db.Uuid
  telegram_user_id BigInt?
  origin           String?   @db.VarChar(50)
  metadata         Json?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  users            User?     @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([created_at], map: "idx_telemetry_events_created_at")
  @@index([event_type], map: "idx_telemetry_events_event_type")
  @@index([user_id], map: "idx_telemetry_events_user_id")
}

model usage_counters {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id         String?  @db.Uuid
  date            DateTime @db.Date
  renders_count   Int?     @default(0)
  downloads_count Int?     @default(0)
  users           User?    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, date])
  @@index([date], map: "idx_usage_counters_date")
  @@index([user_id], map: "idx_usage_counters_user_id")
}

model user_brand_configs {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id          String?   @unique @db.Uuid
  template_id      String?   @default("default_v1") @db.VarChar(100)
  bg_color         String?   @default("#FFFFFF") @db.VarChar(7)
  text_color       String?   @default("#000000") @db.VarChar(7)
  price_color      String?   @db.VarChar(7)
  font_family      String?   @default("Inter") @db.VarChar(100)
  show_coupon      Boolean?  @default(false)
  coupon_text      String?   @db.VarChar(50)
  cta_text         String?   @db.VarChar(100)
  custom_image_url String?   @db.VarChar(500)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)
  users            User?     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_user_brand_configs_user_id")
}

model user_templates {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String   @db.Uuid
  name       String   @db.VarChar(120)
  feed_url   String   @db.VarChar(500)
  story_url  String   @db.VarChar(500)
  type       String   @default("custom") @db.VarChar(50)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  users      User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_user_templates_user_id")
  @@map("user_templates")
}

model user_layout_preferences {
  id                     String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id                String    @unique @db.Uuid

  // Feed/Card layout preferences
  feed_show_title        Boolean   @default(true)
  feed_show_description  Boolean   @default(true)
  feed_show_price        Boolean   @default(true)
  feed_show_original_price Boolean @default(true)
  feed_show_product_url  Boolean   @default(true)
  feed_show_coupon       Boolean   @default(true)
  feed_show_disclaimer   Boolean   @default(false)
  feed_show_sales_quantity Boolean @default(false)
  feed_show_custom_text  Boolean   @default(false)
  feed_order             Json?

  // Story layout preferences
  story_show_title       Boolean   @default(true)
  story_show_price       Boolean   @default(true)
  story_show_original_price Boolean @default(true)
  story_show_coupon      Boolean   @default(true)
  story_show_custom_text Boolean   @default(false)
  story_order            Json?
  story_colors           Json?

  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  users                  User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_user_layout_preferences_user_id")
}

// ============================================================
// MILESTONE_7 - Admin Dashboard Models
// ============================================================

/// Support tickets table - tracks user support requests
model support_tickets {
  id                  String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id             String                 @db.Uuid
  subject             String                 @db.VarChar(255)
  category            String                 @db.VarChar(50)
  status              String                 @default("open") @db.VarChar(50)
  priority            String                 @default("normal") @db.VarChar(20)
  created_at          DateTime               @default(now()) @db.Timestamptz(6)
  updated_at          DateTime               @default(now()) @updatedAt @db.Timestamptz(6)
  users               User                   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  support_messages    support_messages[]
  support_ticket_events support_ticket_events[]

  @@index([user_id], map: "idx_support_tickets_user_id")
  @@index([status], map: "idx_support_tickets_status")
  @@index([priority], map: "idx_support_tickets_priority")
  @@index([created_at(sort: Desc)], map: "idx_support_tickets_created_at")
}

/// Support messages table - conversation thread for tickets
model support_messages {
  id              String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ticket_id       String          @db.Uuid
  sender_role     String          @db.VarChar(20)
  message         String
  attachments     Json?           @default("[]")
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  support_tickets support_tickets @relation(fields: [ticket_id], references: [id], onDelete: Cascade)

  @@index([ticket_id], map: "idx_support_messages_ticket_id")
  @@index([created_at], map: "idx_support_messages_created_at")
}

/// Support ticket events table - audit trail for ticket actions
model support_ticket_events {
  id              String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ticket_id       String          @db.Uuid
  event_type      String          @db.VarChar(50)
  metadata        Json?           @default("{}")
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  support_tickets support_tickets @relation(fields: [ticket_id], references: [id], onDelete: Cascade)

  @@index([ticket_id], map: "idx_support_ticket_events_ticket_id")
  @@index([created_at], map: "idx_support_ticket_events_created_at")
}

/// Payments table - tracks all payment transactions
model payments {
  id                String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id           String             @db.Uuid
  provider          String             @default("kiwify") @db.VarChar(50)
  amount            Decimal            @db.Decimal(10, 2)
  currency          String             @default("BRL") @db.VarChar(3)
  status            String             @db.VarChar(50)
  transaction_id    String?            @unique @db.VarChar(255)
  paid_at           DateTime?          @db.Timestamptz(6)
  created_at        DateTime           @default(now()) @db.Timestamptz(6)
  users             User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  billing_disputes  billing_disputes[]

  @@index([user_id], map: "idx_payments_user_id")
  @@index([status], map: "idx_payments_status")
  @@index([transaction_id], map: "idx_payments_transaction_id")
  @@index([paid_at(sort: Desc)], map: "idx_payments_paid_at")
}

/// Billing disputes table - tracks payment-related issues
model billing_disputes {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id     String    @db.Uuid
  payment_id  String?   @db.Uuid
  issue_type  String    @db.VarChar(100)
  description String?
  status      String    @default("pending") @db.VarChar(50)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  resolved_at DateTime? @db.Timestamptz(6)
  users       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  payments    payments? @relation(fields: [payment_id], references: [id], onDelete: SetNull)

  @@index([user_id], map: "idx_billing_disputes_user_id")
  @@index([status], map: "idx_billing_disputes_status")
  @@index([created_at(sort: Desc)], map: "idx_billing_disputes_created_at")
}

/// Admin users table - staff members with admin access
model admin_users {
  id                String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name              String              @db.VarChar(255)
  email             String              @unique @db.VarChar(255)
  password_hash     String              @db.VarChar(255)
  role              String              @default("ADMIN") @db.VarChar(50)
  is_active         Boolean             @default(true)
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  updated_at        DateTime            @default(now()) @updatedAt @db.Timestamptz(6)
  admin_permissions admin_permissions[]

  @@index([email], map: "idx_admin_users_email")
  @@index([is_active], map: "idx_admin_users_is_active")
}

/// Admin permissions table - granular permission assignments
model admin_permissions {
  id             String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  admin_user_id  String      @db.Uuid
  permission_key String      @db.VarChar(100)
  created_at     DateTime    @default(now()) @db.Timestamptz(6)
  admin_users    admin_users @relation(fields: [admin_user_id], references: [id], onDelete: Cascade)

  @@unique([admin_user_id, permission_key])
  @@index([admin_user_id], map: "idx_admin_permissions_admin_user_id")
}

/// Templates table - stores base and user-uploaded templates
model templates {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String    @db.VarChar(255)
  story_image    String    @db.VarChar(500)
  feed_image     String    @db.VarChar(500)
  category       String    @db.VarChar(100)
  owner_user_id  String?   @db.Uuid
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([category], map: "idx_templates_category")
  @@index([owner_user_id], map: "idx_templates_owner_user_id")
  @@index([is_active], map: "idx_templates_is_active")
}

// ============================================================
// MILESTONE_7 - Promotional Campaigns Models
// ============================================================

/// Campaigns table - stores promotional campaigns created by admins
model campaigns {
  id                  String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                String              @db.VarChar(255)
  price               Decimal             @db.Decimal(10, 2)
  product_url         String              @db.VarChar(500)
  main_video_url      String              @db.VarChar(500)
  created_at          DateTime            @default(now()) @db.Timestamptz(6)
  updated_at          DateTime            @default(now()) @updatedAt @db.Timestamptz(6)
  campaign_assets     campaign_assets[]
  campaign_downloads  campaign_downloads[]

  @@index([created_at(sort: Desc)], map: "idx_campaigns_created_at")
}

/// Campaign assets table - stores additional media files for campaigns
model campaign_assets {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  campaign_id String    @db.Uuid
  asset_url   String    @db.VarChar(500)
  asset_type  String    @db.VarChar(20)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  campaigns   campaigns @relation(fields: [campaign_id], references: [id], onDelete: Cascade)

  @@index([campaign_id], map: "idx_campaign_assets_campaign_id")
}

/// Campaign downloads table - tracks user downloads of campaign materials
model campaign_downloads {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  campaign_id   String    @db.Uuid
  user_id       String    @db.Uuid
  downloaded_at DateTime  @default(now()) @db.Timestamptz(6)
  campaigns     campaigns @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  users         User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([campaign_id], map: "idx_campaign_downloads_campaign_id")
  @@index([user_id], map: "idx_campaign_downloads_user_id")
  @@index([downloaded_at(sort: Desc)], map: "idx_campaign_downloads_downloaded_at")
}
